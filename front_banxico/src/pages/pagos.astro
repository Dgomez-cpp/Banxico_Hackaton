---
import Layout from '../layouts/Layout.astro';
import PaymentsForm from '../components/ui/PaymentsForm.astro';
import CardView from '../components/ui/CardView.astro'; // Para mostrar el historial
import jwt from 'jsonwebtoken';
import type { JwtPayload } from 'jsonwebtoken';

// 1. Definir la interfaz para los datos del historial
interface HistorialPago {
  idPago: number;
  idCuentaOrigen: number;
  idCuentaDestino: number;
  monto: number;
  referencia: string;
  estatus: string;
  fechaPago: string;
  // (Añade cualquier otro campo que devuelva tu SP)
}

// 2. Hacer la página dinámica y verificar la sesión
export const prerender = false;
const SECRET_KEY = 'banxico'; // (La misma clave)

const token = Astro.cookies.get('session')?.value;
let usuario: (JwtPayload & { id: number }) | null = null;
let historial: HistorialPago[] = []; // Array para guardar el historial

if (token) {
  try {
    usuario = jwt.verify(token, SECRET_KEY) as (JwtPayload & { id: number });
  } catch {
    // El token es inválido, 'usuario' sigue siendo null
  }
}

// 3. Si no hay usuario, redirigir al inicio
if (!usuario) {
  return Astro.redirect('/');
}

// 4. Si hay usuario, BUSCAR EL HISTORIAL
try {
  const response = await fetch(`http://localhost:3000/historial/${usuario.id}`);
  if (response.ok) {
    historial = await response.json(); // Llenamos el array con los datos
  } else {
    console.error('Error al cargar el historial de pagos');
  }
} catch (error) {
  console.error('Error de conexión con el backend (historial):', error.message);
}

// 5. Leer mensajes de éxito o error de la URL (después de la redirección)
const success = Astro.url.searchParams.get('success');
const error = Astro.url.searchParams.get('error');
---

<Layout title="Realizar Pagos">
  <div class="container">
    
    <div class="payment-section">
      <PaymentsForm />

      {success && <p class="message success">{success}</p>}
      {error && <p class="message error">{error}</p>}
    </div>

    <div class="history-section">
      <h2>Historial de Transacciones</h2>
      <CardView>
        <div class="history-content">
          {historial.length > 0 ? (
            <ul class="history-list">
              {historial.map((pago) => (
                <li class="history-item">
                  <div class="item-info">
                    <strong>Referencia:</strong> {pago.referencia}
                    <span>{new Date(pago.fechaPago).toLocaleDateString('es-MX')}</span>
                  </div>
                  <div class="item-details">
                    <span class="monto ${pago.idCuentaOrigen === 1 ? 'saliente' : 'entrante'}">
                      {/* Lógica simple para ver si es entrante o saliente, 
                          necesitarías el idCuenta del usuario para hacerlo bien,
                          pero por ahora mostramos el monto */}
                      ${pago.monto.toLocaleString('es-MX')}
                    </span>
                    <span class="status">{pago.estatus}</span>
                  </div>
                </li>
              ))}
            </ul>
          ) : (
            <p>No tienes transacciones registradas.</p>
          )}
        </div>
      </CardView>
    </div>

  </div>
</Layout>

<style>
  .container {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 3rem;
    padding: 2rem;
    min-height: 80vh;
  }

  @media (min-width: 768px) {
    .container {
      flex-direction: row;
      align-items: flex-start;
      gap: 5rem;
    }
  }

  .payment-section, .history-section {
    width: 100%;
    max-width: 600px;
  }
  
  .history-section h2 {
    text-align: center;
    font-size: 2rem;
    color: black;
    margin-bottom: 1.5rem;
  }
  
  .history-content {
    padding: 1rem;
  }

  .history-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .history-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 0.5rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
  }
  .history-item:last-child {
    border-bottom: none;
  }

  .item-info {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }
  .item-info strong {
    font-size: 1rem;
  }
  .item-info span {
    font-size: 0.8rem;
    color: #bd93f9;
  }
  
  .item-details {
    text-align: right;
  }

  .monto {
    font-size: 1.1rem;
    font-weight: bold;
    display: block;
  }
  /* (Esto es un ejemplo, necesitarías la lógica de la cuenta) */
  .saliente { color: #ff5555; }
  .entrante { color: #50fa7b; } 

  .status {
    font-size: 0.85rem;
    background-color: #44475a;
    padding: 2px 6px;
    border-radius: 4px;
  }

  /* Mensajes de feedback */
  .message {
    text-align: center;
    padding: 1rem;
    border-radius: 8px;
    margin-top: 1.5rem;
    font-weight: bold;
  }
  .success {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
  }
  .error {
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
  }
</style>